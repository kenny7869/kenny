(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{440:function(s,a,t){s.exports=t.p+"assets/img/psql-11.b193bab6.png"},485:function(s,a,t){"use strict";t.r(a);var e=t(43),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"資料庫角色、使用者權限管理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#資料庫角色、使用者權限管理"}},[s._v("#")]),s._v(" 資料庫角色、使用者權限管理")]),s._v(" "),e("p",[s._v("PostgreSQL 可以直接針對資料庫的使用者設定權限，也可以先對不同的應用設定好不同的規則（roles），再將不同的規則套用至需要授權的使用者，這樣的方式可以讓管理上夠有彈性，但是可能也會讓管理的操作更為複雜")]),s._v(" "),e("h2",{attrs:{id:"postgresql-資料庫授權層級"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#postgresql-資料庫授權層級"}},[s._v("#")]),s._v(" PostgreSQL 資料庫授權層級")]),s._v(" "),e("p",[s._v("在 PostgreSQL 中的權限有分為 database、schema 與 object 三個層級，想要授權使用者存取一張資料表（table），就要同時確認該使用者也擁有該資料表所在 database 以及 schema 的存取權限，如果中間缺少了任何一層的權限，就會無法存取")]),s._v(" "),e("p",[e("img",{attrs:{src:t(440),alt:"psql-11",title:"psql-11"}})]),s._v(" "),e("h2",{attrs:{id:"建立資料庫的使用者"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建立資料庫的使用者"}},[s._v("#")]),s._v(" 建立資料庫的使用者")]),s._v(" "),e("p",[s._v("可以使用 "),e("code",[s._v("CREATE USER")]),s._v(" 或 "),e("code",[s._v("CREATE ROLE")]),s._v(" 指令：")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- CREATE USER 指令")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" username\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" PASSWORD "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- CREATE ROLE 指令")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" ROLE username\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" LOGIN PASSWORD "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("h2",{attrs:{id:"public-schema-與-public-角色"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#public-schema-與-public-角色"}},[s._v("#")]),s._v(" public Schema 與 public 角色")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("當一個全新的 PostgreSQL 資料庫被建立時，預設會自動建立一個名稱為 public 的 schema，並將存取權限授予 public 這一個角色，新建立的使用者預設只會繼承 public 角色中所開放的權限，其餘權限都沒有開放")])]),s._v(" "),e("li",[e("p",[s._v("當需要建立一個唯讀的使用者帳號（只能讀取、不可寫入資料）時，就必須將 public 角色中的可在 public schema 建立物件的權限拿掉")])])]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REVOKE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PUBLIC")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 將 public 角色連線至指定資料庫的權限撤除")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REVOKE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" databasename "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PUBLIC")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("p",[s._v("經過這樣的設定之後，需要連線至資料庫的使用者都需要明確以指令進行授權，否則都不可以連線至資料庫")]),s._v(" "),e("h2",{attrs:{id:"建立資料庫角色"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建立資料庫角色"}},[s._v("#")]),s._v(" 建立資料庫角色")]),s._v(" "),e("p",[s._v("為了給使用者分配權限，使用 "),e("code",[s._v("GRANT")]),s._v(" 指令"),e("br"),s._v("\n語法：")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" privilege "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" object "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" { "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PUBLIC")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GROUP")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("group")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" username }\n")])])]),e("p",[s._v("privilege 可能的值有：SELECT, INSERT, UPDATE, USAGE, DELETE, RULE, ALL"),e("br"),s._v("\nobject 可能的物件是：表、視圖、序列"),e("br"),s._v("\nPUBLIC：代表所有使用者"),e("br"),s._v("\nGROUP group：代表群組"),e("br"),s._v("\nusername：授予權限的使用者名稱")]),s._v(" "),e("ul",[e("li",[s._v("設定唯讀角色")])]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予角色可連線至資料庫的權限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CONNECT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" databasename "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--授予角色可使用 schema 的權限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USAGE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--授予角色可對 schema 的所有資料表進行 SELECT 操作")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予角色可對單一資料表進行 SELECT 操作")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" tablename "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 設定角色對 schema 新資料表的預設權限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("ul",[e("li",[s._v("設定讀寫角色")])]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予角色可在 schema 中使用或建立物件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USAGE")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予角色可對 schema 的特定資料表進行各種操作")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" tablename "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 設定角色對 schema 新資料表的預設權限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("p",[s._v("對於讀寫角色而言，通常都會需要對 sequences 的使用進行授權")]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予角色可以使用指定的 Sequence")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USAGE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" SEQUENCE Sequencename "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 授予角色可以使用所有的 Sequences")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USAGE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),s._v(" SEQUENCES "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 設定角色對 schema 新 Sequences 的預設權限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIVILEGES")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SCHEMA")]),s._v(" schemaname\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USAGE")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" SEQUENCES "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" username"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("h2",{attrs:{id:"紀錄資料庫帳號的特定行為"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#紀錄資料庫帳號的特定行為"}},[s._v("#")]),s._v(" 紀錄資料庫帳號的特定行為")]),s._v(" "),e("ul",[e("li",[s._v("修改 postgresql.conf 檔案")])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/lib/pgsql/9.6/data\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" postgresql.conf\n")])])]),e("ul",[e("li",[s._v("找到 "),e("code",[s._v("log_statement")]),s._v(" 設定為 "),e("code",[s._v("none")])])]),s._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[s._v("log_statement "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'none'")]),s._v("\n")])])]),e("ul",[e("li",[s._v("再進到資料庫針對特定帳號設定 log_statement 為 mod")])]),s._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" role postgres "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" log_statement "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mod'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);