# Linux 磁碟管理

Linux 磁碟管理好壞直接關係到整個系統的性能問題
Linux 磁碟管理常用三個命令為 `df`， `du` 和 `fdisk`

- `df`：列出文件系統的整體磁碟使用量
- `du`：檢查磁碟空間使用量
- `fdisk`：用於磁碟分區

## df 命令

功能：檢查文件系統的磁碟空間佔用情況，可以利用該命令來獲取硬碟被佔用了多少空間，目前還剩下多少空間等資訊
語法：

```sh
df [ -ahikHTm ] [目錄或文件名]
```

選項與參數：

- `-a`：列出所有的文件系統，包括系統特有的 `proc` 等文件系統
- `-k`：以 `KB` 的容量顯示各文件系統
- `-m`：以 `MB` 的容量顯示各文件系統
- `-h`：以人們較易閱讀的 GB，MB，KB 等格式自行顯示
- `-H`：以 M = 1000K 取代 M = 1024K 的進位方式
- `-T`：顯示文件系統類型，並合併該分區的文件系統名稱（例如：ext3）也列出
- `-i`：不用硬碟容量，而以 inode 的數量來顯示

## du 命令

功能：du 命令也是查看使用空間的，但是與 df 命令不同的是 du命令是對文件和目錄磁碟使用的空間的查看，還是和 df 命令有一些區別的
語法：

```sh
du [-ahskm] 文件或目錄名稱
```

選項與參數：

- `-a`：列出所有的文件與目錄容量，因為默認僅統計目錄底下的文件量而已
- `-h`：以人們較易讀的容量格式 (G/M) 顯示
- `-s`：列出總量而已，而不列出每個各別的目錄佔用容量
- `-S`：不包括子目錄下的總計，與 `-s` 有點差別
- `-k`：以 `KB` 列出容量顯示
- `-m`：以 `MB` 列出容量顯示

要找到磁碟佔用最大的檔案，先至根目錄下利用以下指令：

```sh
du -h --max-depth=1
```

- `–max-depth` 是表示查詢子目錄的層級

## fdisk 命令

功能：fdisk 是 Linux 的磁碟分區表操作工具
語法：

```sh
fdisk [-l] 裝置名稱
```

選項與參數：

- `-l`：輸出後面接的裝置所有的分區內容。若僅有 fdisk -l 時，則系統將會把整個系統內能夠搜尋到的裝置的分區均列出來
- `-u`： 與 -l 搭配使用，顯示分區數目
- `-s`：<分區編號> 指定分區
- `-v`：版本信息

選單操作說明：

- m：顯示選單和幫助信息
- a：活動分區標記/引導分區
- d：刪除分區
- l：顯示分區類型
- n：新建分區
- p：顯示分區信息
- q：退出不保存
- t：設置分區號
- v：進行分區檢查
- w：保存修改
- x：擴展應用，高級功能

## 磁碟格式化 mkfs

磁盤分割完畢後自然就是要進行文件系統的格式化，格式化的命令非常的簡單，使用 mkfs（make filesystem）命令
語法：

```sh
mkfs [-V] [-t fstype] [fs-options] filesys [blocks]
```

選項與參數：

- device ： 預備檢查的硬碟分區，例如：/dev/sda1
- `-V`：詳細顯示模式
- `-t`：給定檔案系統的型式，Linux 的預設值為 ext2
- `-c`：在製做檔案系統前，檢查該 partition 是否有壞軌
- `-l bad_blocks_file`：將有壞軌的 block 資料加到 bad_blocks_file 裡面
- `block`：給定 block 的大小

實例：
查看 mkfs 支持的文件格式

```sh
mkfs [tab][tab]
mkfs.cramfs  mkfs.ext2    mkfs.ext3    mkfs.msdos   mkfs.vfat
```

在 `/dev/hda5` 上建一個 msdos 的檔案系統，同時檢查是否有壞軌存在，並且將過程詳細列出來：

```sh
mkfs -V -t msdos -c /dev/hda5
```

將 `sda6` 分區格式化為 ext3 格式

```sh
mkfs -t ext3 /dev/sda6
```

## 磁碟檢驗 fsck

fsck（file system check）用來檢查和維護不一致的文件系統
若磁碟發生問題，可利用 fsck 命令對文件系統進行檢查
語法：

```sh
fsck [-sACVRP] [-t fstype] [--] [fsck-options] filesys [...]
```

選項與參數：

- `-t`：給定檔案系統的型式，若在 `/etc/fstab` 中已有定義或 kernel 本身已支援的則不需加上此參數
- `-s`：依序一個一個地執行 fsck 的指令來檢查
- `-A`：對 `/etc/fstab` 中所有列出來的分區（partition）做檢查
- `-C`：顯示完整的檢查進度
- `-d`：打印出 e2fsck 的 debug 結果
- `-p`：同時有 `-A` 條件時，同時有多個 fsck 的檢查一起執行
- `-R`：同時有 `-A` 條件時，省略 `/` 不檢查
- `-V`：詳細顯示模式
- `-a`：如果檢查有錯則自動修復
- `-r`：如果檢查有錯則由使用者回答是否修復
- `-y`：選項指定檢測每個文件是自動輸入 yes，在不確定那些是不正常的時候，可以執行 `fsck -y` 全部檢查修復

## 磁碟掛載與卸除

Linux 的磁碟掛載使用 mount 命令，卸載使用 umount 命令
mount 語法：

```sh
mount [-hV]
mount -a [-fFnrsvw] [-t vfstype]
mount [-fnrsvw] [-o options [,...]] device | dir
mount [-fnrsvw] [-t vfstype] [-o options] device dir
```

參數說明：

- `-V`：顯示程序版本
- `-h`：顯示輔助訊息
- `-v`：顯示較訊息，通常和 `-f` 用來除錯。
- `-a`：將 `/etc/fstab` 中定義的所有檔案系統掛上。
- `-F`：這個命令通常和 `-a` 一起使用，它會為每一個 mount 的動作產生一個行程負責執行。在系統需要掛上大量 NFS 檔案系統時可以加快掛上的動作。
- `-f`：通常用在除錯的用途。它會使 mount 並不執行實際掛上的動作，而是模擬整個掛上的過程。通常會和 `-v` 一起使用。
- `-n`：一般而言，mount 在掛上後會在 `/etc/mtab` 中寫入一筆資料。但在系統中沒有可寫入檔案系統存在的情況下可以用這個選項取消這個動作
- `-sr`：等於 `-o ro`
- `-w`：等於 `-o rw`
- `-L`：將含有特定標籤的硬盤分割掛上
- `-U`：將檔案分割序號為的檔案系統掛下。 `-L` 和 `-U` 必須在 `/proc/partition` 這種檔案存在時才有意義
- `-t`：指定檔案系統的型態，通常不必指定。mount 會自動選擇正確的型態
- `-o async`：打開非同步模式，所有的檔案讀寫動作都會用非同步模式執行
- `-o sync`：在同步模式下執行
- `-o atime`、 `-o noatime` ：當 `atime` 打開時，系統會在每次讀取檔案時更新檔案的『上一次調用時間』
- `-o auto`、`-o noauto`：打開/關閉自動掛上模式。
- `-o defaults`：使用預設的選項 rw, suid, dev, exec, auto, nouser, and async.
- `-o dev`、`-o nodev`、`-o exec`、`-o noexec`：允許執行檔被執行。
- `-o suid`、`-o nosuid`：允許執行檔在 root 權限下執行。
- `-o user`、`-o nouser`：使用者可以執行 `mount/umount` 的動作。
- `-o remount`：將一個已經掛下的檔案系統重新用不同的方式掛上。例如原先是唯讀的系統，現在用可讀寫的模式重新掛上
- `-o ro`：用唯讀模式掛上
- `-o rw`：用可讀寫模式掛上
- `-o loop=`：使用 loop 模式用來將一個檔案當成硬盤分割掛上系統

umount 語法：

```sh
umount [- ahnrvV ][- t <文件系統類型>][文件系統]
```

參數：

- `-a`：卸除/etc/mtab中記錄的所有文件系統
- `-h`：顯示幫助
- `-n`：卸除時不要將信息存入 `/etc/mtab` 文件中
- `-r`：若無法成功卸除，則嘗試以唯讀的方式重新掛入文件系統
- `-t`<文件系統類型>：僅卸除選項中所指定的文件系統
- `-v`：執行時顯示詳細的信息
- `-V`：顯示版本信息
- [文件系統]：除了直接指定文件系統外，也可以用設備名稱或掛入點來表示文件系統